name: Pixel-Perfect Validation

on:
  push:
    branches: [main, v1, v1.1]
    paths:
      - 'src/stories/**'
      - 'tests/**'
      - '.storybook/**'
  # pull_request:  # ‚Üê DESABILITADO TEMPORARIAMENTE
  #   branches: [main, v1, v1.1]
  #   paths:
  #     - 'src/stories/**'
  #     - 'tests/**'
  #     - '.storybook/**'
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Atualizar screenshots baseline'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pixel-perfect:
    name: Valida√ß√£o Pixel-Perfect
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üìö Instalar depend√™ncias
        run: npm ci

      - name: üèóÔ∏è Build Storybook
        run: npm run build-storybook

      - name: üé≠ Instalar Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: üñ•Ô∏è Iniciar servidor Storybook
        run: |
          npx http-server storybook-static -p 6006 --silent &
          sleep 5
          curl -s http://localhost:6006 > /dev/null || exit 1
          echo "‚úÖ Storybook rodando na porta 6006"

      - name: üì∏ Validar Screenshots (Componentes Manuais)
        if: ${{ github.event.inputs.update_snapshots != 'true' }}
        run: |
          npx playwright test --grep "Pixel Perfect - Componentes Manuais" --reporter=html
        continue-on-error: false

      - name: üì∏ Validar Screenshots (Todos os Componentes)
        if: ${{ github.event.inputs.update_snapshots != 'true' }}
        run: |
          npx playwright test --grep "Pixel Perfect - Todos os Componentes" --reporter=html
        continue-on-error: false

      - name: ÔøΩ Validar Screenshots Responsivos (Mobile/Tablet/Desktop)
        if: ${{ github.event.inputs.update_snapshots != 'true' }}
        run: |
          npx playwright test --grep "Responsividade" --reporter=html
        continue-on-error: false

      - name: ÔøΩüîÑ Atualizar Screenshots Baseline
        if: ${{ github.event.inputs.update_snapshots == 'true' }}
        run: |
          npx playwright test --grep "Pixel Perfect" --update-snapshots --reporter=list
          echo "‚úÖ Screenshots atualizados"

      - name: üì§ Upload Relat√≥rio Playwright
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: üì§ Upload Screenshots Diff
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshot-diffs
          path: test-results/
          retention-days: 7

      - name: üì§ Upload Screenshots Atualizados
        uses: actions/upload-artifact@v4
        if: ${{ github.event.inputs.update_snapshots == 'true' }}
        with:
          name: updated-snapshots
          path: tests/educacross-pixel-perfect.spec.js-snapshots/
          retention-days: 7

      - name: üìä Resumo do Teste
        if: always()
        run: |
          echo "## üìä Resultados da Valida√ß√£o Pixel-Perfect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| M√©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | Pixel-Perfect Validation |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ‚úÖ Todos os testes passaram!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Alguns testes falharam" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Verifique os artefatos para ver os diffs de screenshots." >> $GITHUB_STEP_SUMMARY
          fi

  notify-failure:
    name: Notificar Falha
    runs-on: ubuntu-latest
    needs: pixel-perfect
    if: failure()
    
    steps:
      - name: üö® Criar coment√°rio no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Valida√ß√£o Pixel-Perfect Falhou\n\nAlguns componentes t√™m diferen√ßas visuais. Verifique o [relat√≥rio do Playwright](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) para detalhes.\n\n### üîß Para corrigir:\n1. Execute localmente: `npx playwright test --grep "Pixel Perfect"`\n2. Se as mudan√ßas s√£o intencionais: `npx playwright test --update-snapshots`\n3. Commit os novos screenshots'
            })
